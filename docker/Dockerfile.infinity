# ⚠️  INFINITY IMAGE - DEVELOPMENT/TESTING ONLY ⚠️
# This image includes a non-root user with passwordless sudo access.
# DO NOT use this in production environments.

# Base image from the main Clawdbot build
FROM ghcr.io/sunwood-ai-oss-hub/agentos-clawd-agent3:latest

# Install Playwright globally first
RUN npm install -g playwright

# Install Playwright Chromium and system dependencies
RUN npx playwright install --with-deps chromium

# Install agent-browser globally
RUN npm install -g agent-browser

# Install sudo, GitHub CLI, and git
RUN apt-get update && \
    apt-get install -y --no-install-recommends sudo curl git && \
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list && \
    apt-get update && \
    apt-get install -y gh && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# Create a non-root user with passwordless sudo access
# Also add to node group so we can access /home/node/clawd
RUN useradd -m -s /bin/bash agent && \
    echo "agent ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/agent && \
    chmod 440 /etc/sudoers.d/agent && \
    usermod -aG node agent && \
    chmod 777 /home/agent

# Ensure /home/node directory exists and is writable by node group
RUN mkdir -p /home/node && \
    chown -R node:node /home/node && \
    chmod -R 775 /home/node

# Install agent-browser skill
RUN mkdir -p /app/skills/agent-browser && \
    curl -o /app/skills/agent-browser/SKILL.md \
      https://raw.githubusercontent.com/vercel-labs/agent-browser/main/skills/agent-browser/SKILL.md && \
    chown -R node:node /app/skills

# Install remotion skill (using git clone)
RUN mkdir -p /app/skills && \
    cd /tmp && \
    git clone --depth 1 --filter=blob:none --sparse https://github.com/remotion-dev/remotion.git && \
    cd remotion && \
    git sparse-checkout set packages/skills/skills/remotion && \
    cp -r packages/skills/skills/remotion /app/skills/ && \
    cd / && \
    rm -rf /tmp/remotion && \
    chown -R node:node /app/skills

# Install Claude Code CLI (cc-st, cc-glm, ccd-st, ccd-glm)
RUN curl -fsSL https://raw.githubusercontent.com/Sunwood-ai-labs/zero-cc/main/script/install.sh | bash

# Set working directory
WORKDIR /app

# Switch to the agent user
USER agent

# Install Claude Code CLI for agent user
RUN curl -fsSL https://raw.githubusercontent.com/Sunwood-ai-labs/zero-cc/main/script/install.sh | bash && \
    chmod +x /home/agent/.bashrc.d/*.sh

# Keep the same entrypoint as base image (will run as agent user)
CMD ["node", "dist/index.js"]
